##############################################################################
#
#    Copyright (c) 2005 - 2020 by Vivante Corp.  All rights reserved.
#
#    The material in this file is confidential and contains trade secrets
#    of Vivante Corporation. This is proprietary information owned by
#    Vivante Corporation. No part of this work may be disclosed,
#    reproduced, copied, transmitted, or used in any way for any purpose,
#    without the express written permission of Vivante Corporation.
#
##############################################################################


#
# Common include file for Android build
#

ifeq ($(VIVANTE_ANDROID_MK_DEF),)
VIVANTE_ANDROID_MK_DEF := 1

################################################################################
# Options.

# Select prebuilt binary types.
FIXED_ARCH_TYPE              ?=

# Set this variable to Kernel directory.
ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 28),1)
ifeq ($(KERNEL_OUT),)
KERNEL_OUT := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ
endif
endif

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 28),1)
KERNEL_DIR                   ?= $(abspath $(OUT_DIR))/../$(KERNEL_OUT)
else ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 26),1)
KERNEL_DIR                   ?= $(ANDROID_BUILD_TOP)/$(KERNEL_OUT)
else
KERNEL_DIR                   ?= $(ANDROID_BUILD_TOP)/kernel_imx
endif

# Cross compiler for building kernel module.
ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 28),1)
  ifeq ($(TARGET_ARCH),arm64)
    CROSS_COMPILE            ?= $(abspath $(OUT_DIR))/../prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
  else
    CROSS_COMPILE            ?= $(abspath $(OUT_DIR))/../prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-
  endif
else ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 23),1)
  ifeq ($(TARGET_ARCH),arm64)
    CROSS_COMPILE            ?= $(ANDROID_BUILD_TOP)/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
  else
    CROSS_COMPILE            ?= $(ANDROID_BUILD_TOP)/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-
  endif
else
  ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 17),1)
    CROSS_COMPILE            ?= $(ANDROID_BUILD_TOP)/prebuilts/gcc/linux-x86/arm/arm-eabi-4.6/bin/arm-eabi-
  else
    CROSS_COMPILE            ?= $(ANDROID_BUILD_TOP)/prebuilt/linux-x86/toolchain/arm-eabi-4.4.3/bin/arm-eabi-
  endif
endif

# CPU arch for kernel module build.
ARCH_TYPE                    ?= $(TARGET_ARCH)

# HAL module variant, for gralloc.<variant>.so, etc.
HAL_MODULE_VARIANT           ?= $(TARGET_BOARD_PLATFORM)

# Enable debug.
DEBUG                        ?= 0

USE_OPENCL ?= 1
USE_OPENVX                   ?= 1
USE_VULKAN                   ?= 1

USE_VXC_BINARY  ?=0
GPU_CONFIG  ?=gpu_imx8qm
VIVANTE_ENABLE_3D            ?= 1
VIVANTE_ENABLE_2D            ?= 1
VIVANTE_ENABLE_VG            ?= 1
VIVANTE_ENABLE_VSIMULATOR    ?= 0

#If need to user ori arch model, set to 1
ORI_NNARCHPERF   ?= 0

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 27),1)
PLATFORM_VENDOR              ?= 1
endif
# Specific soc platform in <vendor>-<board> format, or 'default'.
SOC_PLATFORM                 ?= freescale-imx


################################################################################
# Variables.

GPU_VENDOR    := VIVANTE

HAL_MODULE_VARIANT := \
    $(firstword \
        $(strip $(HAL_MODULE_VARIANT)) \
        $(TARGET_BOOTLOADER_BOARD_NAME) \
        $(TARGET_BOARD_PLATFORM)\
        default \
    )

AQROOT        := $(call my-dir)
AQARCH        := $(AQROOT)/arch/XAQ2
AQVGARCH      := $(AQROOT)/arch/GC350

ifeq ($(USE_OPENCL),1)
BUILD_OPENCL_ICD := 0
ENABLE_CL_GL     := 1
else
BUILD_OPENCL_ICD := 0
ENABLE_CL_GL     := 0
endif

ifeq ($(VIVANTE_ENABLE_VSIMULATOR),1)
USE_OPENVX        := 1
VIVANTE_ENABLE_2D := 0
ENABLE_CL_GL      := 0
endif

ifneq ($(filter vivante,$(BOARD_GPU_DRIVERS)),)
DRM_GRALLOC      := 1
else
DRM_GRALLOC      := 0
endif

# Path to hold built modules besides $(PRODUCT_OUT)
# deprecated.
VIV_OUT       ?= $(AQROOT)/build

################################################################################
# Target CFLAGS.

CFLAGS        := -DLINUX

CFLAGS        += -DgcdENABLE_3D=$(VIVANTE_ENABLE_3D)
CFLAGS        += -DgcdENABLE_2D=$(VIVANTE_ENABLE_2D)
CFLAGS        += -DgcdENABLE_VG=$(VIVANTE_ENABLE_VG)
CFLAGS        += -DgcdUSE_VX=$(USE_OPENVX)
CFLAGS        += -DgcdUSE_VXC_BINARY=$(USE_VXC_BINARY)


ifeq ($(USE_BROKER),1)
CFLAGS            += -DgcdUSE_BROKER=1
CFLAGS            += -DNO_KERNEL
endif

ifeq ($(VIVANTE_ENABLE_VSIMULATOR),1)
CFLAGS        += -DNO_VDT_PROXY -DVSIMULATOR_DEBUG -DgcdSECURITY=0 -DEMULATOR
endif

CFLAGS        += -DUSE_VDK=0

PLATFORM_SDK_VERSION ?= 12

CFLAGS        += -DANDROID_SDK_VERSION=$(PLATFORM_SDK_VERSION)
CFLAGS        += -fno-strict-aliasing -fno-short-enums
CFLAGS        += -Wno-missing-field-initializers -Wno-unused-parameter

ifeq ($(DEBUG),1)
CFLAGS        += -DDBG=1 -DDEBUG -D_DEBUG -O0 -g
else
CFLAGS        += -DgcdEMPTY_HEADER_FOOTER=1
endif

CFLAGS        += -DVIVANTE_PROFILER=1
CFLAGS        += -DVIVANTE_PROFILER_CONTEXT=1

FPGA_BUILD    ?= 0
CFLAGS        += -DgcdFPGA_BUILD=$(FPGA_BUILD)

# Disable implicit native buffer sync on kitkat and later.
# Kitkat and later will use KHR_fence_sync or ANDROID_native_fence_sync
# to keep buffers sync-ed.
# Please see frameworks/native/libs/gui/SyncFeatures.cpp
ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 19),1)
CFLAGS        += -DgcdANDROID_IMPLICIT_NATIVE_BUFFER_SYNC=0
endif

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 26),1)
CFLAGS        += -Wno-typedef-redefinition
endif

# For clang.
ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 28),1)
CFLAGS        += -Wno-parentheses-equality -Wno-self-assign
else
ifeq ($(USE_CLANG_PLATFORM_BUILD),true)
CFLAGS        += -Wno-parentheses-equality -Wno-self-assign -Wno-strncat-size
endif
endif

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 26),1)
CFLAGS        += -DFSL_ADD_RESERVE
endif

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) "==" 25),1)
ifeq ($(TARGET_PRODUCT),evk_8mq)
CFLAGS        += -DFSL_ADD_RESERVE
endif
endif

ifneq ($(filter libdrm_imx,$(BOARD_GPU_LIBDRM)),)
LIBDRM_IMX      := 1
else
LIBDRM_IMX      := 0
endif

#If need to user ori arch model, set to 1
#CFLAGS              += -DORI_NNARCHPERF

soc_vendor    := $(firstword $(subst -, ,$(SOC_PLATFORM)))
soc_board     := $(lastword  $(subst -, ,$(SOC_PLATFORM)))

-include $(LOCAL_PATH)/hal/os/linux/user/platform/$(soc_vendor)/gc_hal_user_platform_$(soc_board).config

endif

