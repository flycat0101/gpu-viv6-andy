##############################################################################
#
#    Copyright (c) 2005 - 2017 by Vivante Corp.  All rights reserved.
#
#    The material in this file is confidential and contains trade secrets
#    of Vivante Corporation. This is proprietary information owned by
#    Vivante Corporation. No part of this work may be disclosed,
#    reproduced, copied, transmitted, or used in any way for any purpose,
#    without the express written permission of Vivante Corporation.
#
##############################################################################


#
#  Common include file for Android build
#

ifeq ($(VIVANTE_ANDROID_MK_DEF),)
VIVANTE_ANDROID_MK_DEF := 1

################################################################################
# Options.

# Select prebuilt binary types.
FIXED_ARCH_TYPE              ?=

# Set this variable to Kernel directory.
KERNEL_DIR                   ?= $(ANDROID_BUILD_TOP)/kernel/kernel

# Cross compiler for building kernel module.
CROSS_COMPILE                ?= $(notdir $(TARGET_TOOLS_PREFIX))

# CPU arch for kernel module build.
ARCH_TYPE                    ?= $(TARGET_ARCH)

# HAL module variant, for gralloc.<variant>.so, etc.
HAL_MODULE_VARIANT           ?=

# Enable debug.
DEBUG                        ?= 0

USE_OPENCL ?= 1
USE_OPENVX                   ?= 0
USE_VULKAN                   ?= 0

VIVANTE_ENABLE_3D            ?= 1
VIVANTE_ENABLE_2D            ?= 1
VIVANTE_ENABLE_VG            ?= 0

# Specific soc platform in <vendor>-<board> format, or 'default'.
SOC_PLATFORM                 ?= default


################################################################################
# Variables.

GPU_VENDOR    := VIVANTE

HAL_MODULE_VARIANT := \
    $(firstword \
        $(strip $(HAL_MODULE_VARIANT)) \
        $(TARGET_BOOTLOADER_BOARD_NAME) \
        $(TARGET_BOARD_PLATFORM)\
        default \
    )

AQROOT        := $(call my-dir)
AQARCH        := $(AQROOT)/arch/XAQ2
AQVGARCH      := $(AQROOT)/arch/GC350

export KERNEL_DIR
export CROSS_COMPILE
export ARCH_TYPE

ifeq ($(USE_OPENCL),1)
BUILD_OPENCL_ICD := 1
ENABLE_CL_GL     := 1
else
BUILD_OPENCL_ICD := 0
ENABLE_CL_GL     := 0
endif

ifneq ($(filter vivante,$(BOARD_GPU_DRIVERS)),)
DRM_GRALLOC      := 1
else
DRM_GRALLOC      := 0
endif

# Path to hold built modules besides $(PRODUCT_OUT)
# deprecated.
VIV_OUT       ?= $(AQROOT)/build

################################################################################
# Target CFLAGS.

CFLAGS        := -DLINUX

CFLAGS        += -DgcdENABLE_3D=$(VIVANTE_ENABLE_3D)
CFLAGS        += -DgcdENABLE_2D=$(VIVANTE_ENABLE_2D)
CFLAGS        += -DgcdENABLE_VG=$(VIVANTE_ENABLE_VG)
CFLAGS        += -DgcdUSE_VX=$(USE_OPENVX)

CFLAGS        += -DUSE_VDK=0

PLATFORM_SDK_VERSION ?= 12

CFLAGS        += -DANDROID_SDK_VERSION=$(PLATFORM_SDK_VERSION)
CFLAGS        += -fno-strict-aliasing -fno-short-enums
CFLAGS        += -Wno-missing-field-initializers -Wno-unused-parameter

ifeq ($(DEBUG), 1)
CFLAGS        += -DDBG=1 -DDEBUG -D_DEBUG -O0 -g
endif

CFLAGS        += -DVIVANTE_PROFILER=1
CFLAGS        += -DVIVANTE_PROFILER_CONTEXT=1

FPGA_BUILD    ?= 0
CFLAGS        += -DgcdFPGA_BUILD=$(FPGA_BUILD)

# Disable implicit native buffer sync on kitkat and later.
# Kitkat and later will use KHR_fence_sync or ANDROID_native_fence_sync
# to keep buffers sync-ed.
# Please see frameworks/native/libs/gui/SyncFeatures.cpp
ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 19),1)
CFLAGS        += -DgcdANDROID_IMPLICIT_NATIVE_BUFFER_SYNC=0
endif

ifeq ($(shell expr $(PLATFORM_SDK_VERSION) ">=" 26),1)
CFLAGS        += -Wno-typedef-redefinition
endif

# For clang.
ifeq ($(USE_CLANG_PLATFORM_BUILD),true)
CFLAGS        += -Wno-parentheses-equality -Wno-self-assign
endif

soc_vendor    := $(firstword $(subst -, ,$(SOC_PLATFORM)))
soc_board     := $(lastword  $(subst -, ,$(SOC_PLATFORM)))

-include $(LOCAL_PATH)/hal/os/linux/user/platform/$(soc_vendor)/gc_hal_user_platform_$(soc_board).config

endif

